<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Discovery - BADA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-body: #f5f5f7;
      --bg-surface: #ffffff;
      --bg-subtle: #f9fafb;
      --border-subtle: #e5e7eb;
      --border-strong: #d1d5db;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --success: #10b981;
      --success-soft: #d1fae5;
      --danger: #ef4444;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --shadow-soft: 0 14px 40px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e5f0ff, #f5f5f7 45%);
      color: var(--text-main);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(245, 245, 247, 0.9), rgba(245, 245, 247, 0.7));
      border-bottom: 1px solid rgba(229, 231, 235, 0.8);
    }

    .header-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #93c5fd, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 12px 35px rgba(37, 99, 235, 0.45);
    }

    .brand-text-main {
      font-weight: 650;
      letter-spacing: 0.02em;
      font-size: 17px;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.12s ease;
      text-decoration: none;
    }

    .btn-back:hover {
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }

    /* Main Layout */
    main {
      flex: 1;
    }

    .content-wrapper {
      max-width: 1120px;
      margin: 24px auto;
      padding: 0 20px 32px 20px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      align-items: flex-start;
    }

    /* Sidebar - Deal Info */
    .sidebar-panel {
      position: sticky;
      top: 90px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 18px;
      border: 1px solid rgba(229, 231, 235, 0.9);
      box-shadow: var(--shadow-soft);
      padding: 18px;
    }

    .sidebar-header {
      margin-bottom: 12px;
    }

    .sidebar-title {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 4px 0;
    }

    .sidebar-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .deal-info-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 12px;
    }

    .deal-info-item:last-child {
      border-bottom: none;
    }

    .deal-info-label {
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 3px;
    }

    .deal-info-value {
      color: var(--text-main);
    }

    .progress-indicator {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .progress-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .progress-bar {
      height: 6px;
      background: var(--bg-subtle);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #34d399, #10b981);
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    /* Main Content */
    .main-panel {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(229, 231, 235, 0.9);
      box-shadow: var(--shadow-soft);
      padding: 20px;
    }

    .main-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .main-title {
      font-size: 20px;
      font-weight: 650;
      margin: 0 0 6px 0;
    }

    .main-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* Phase Sections */
    .phase-sections {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .phase-section {
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: linear-gradient(135deg, rgba(249, 250, 251, 0.96), rgba(255, 255, 255, 0.98));
      overflow: hidden;
      transition: all 0.15s ease;
    }

    .phase-section:hover {
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
      border-color: rgba(37, 99, 235, 0.2);
    }

    .phase-header {
      padding: 14px 16px;
      background: linear-gradient(135deg, #f9fafb, #ffffff);
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.15s ease;
    }

    .phase-header:hover {
      background: linear-gradient(135deg, #f3f4f6, #f9fafb);
    }

    .phase-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .phase-number {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent-soft), var(--accent));
      color: var(--accent-strong);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .phase-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    .phase-toggle {
      font-size: 18px;
      color: var(--text-muted);
      transition: transform 0.2s ease;
    }

    .phase-section.open .phase-toggle {
      transform: rotate(180deg);
    }

    .phase-content {
      display: none;
      padding: 16px;
    }

    .phase-section.open .phase-content {
      display: block;
    }

    /* Question Fields */
    .question-field {
      margin-bottom: 14px;
    }

    .question-label {
      font-size: 13px;
      font-weight: 500;
      color: #4b5563;
      margin-bottom: 6px;
      display: block;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px 12px;
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      background: var(--bg-subtle);
      font-size: 13px;
      font-family: inherit;
      color: var(--text-main);
      resize: vertical;
      transition: all 0.15s ease;
      outline: none;
    }

    textarea:focus {
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12);
    }

    textarea::placeholder {
      color: #9ca3af;
    }

    /* Buttons */
    .phase-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .btn-primary {
      border: none;
      border-radius: var(--radius-pill);
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
      font-size: 13px;
      font-weight: 600;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.35);
      transition: all 0.12s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #10b981, #059669);
      transform: translateY(-1px);
      box-shadow: 0 14px 36px rgba(5, 150, 105, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(5, 150, 105, 0.35);
    }

    .btn-secondary {
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-pill);
      background: #ffffff;
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.12s ease;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
      transform: translateY(-0.5px);
    }

    /* Output Boxes */
    .output-boxes {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .output-box {
      padding: 12px 14px;
      border-radius: 10px;
      background: var(--success-soft);
      border-left: 4px solid var(--success);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .output-box strong {
      display: block;
      margin-bottom: 6px;
      color: var(--text-main);
      font-size: 13px;
    }

    .output-loading {
      background: var(--accent-soft);
      border-left-color: var(--accent);
      color: var(--accent-strong);
    }

    .output-error {
      background: #fee2e2;
      border-left-color: var(--danger);
      color: #991b1b;
    }

    /* Save Banner */
    .save-banner {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius-pill);
      box-shadow: 0 14px 40px rgba(16, 185, 129, 0.5);
      font-size: 13px;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideUp 0.3s ease;
    }

    .save-banner.show {
      display: flex;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 960px) {
      .content-wrapper {
        grid-template-columns: 1fr;
      }

      .sidebar-panel {
        position: relative;
        top: 0;
      }
    }

    @media (max-width: 520px) {
      .header-inner {
        padding-inline: 14px;
      }

      .content-wrapper {
        padding-inline: 14px;
      }

      .brand-text-sub {
        display: none;
      }

      .phase-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="header-inner">
        <div class="brand">
          <div class="brand-logo">B</div>
          <div>
            <div class="brand-text-main">BADA</div>
            <div class="brand-text-sub">Discovery Â· Buyer Journey Mapping</div>
          </div>
        </div>
        <div class="header-actions">
          <a href="index.html" class="btn-back">
            <span>â†</span>
            <span>Deal ëª©ë¡</span>
          </a>
        </div>
      </div>
    </header>

    <main>
      <div class="content-wrapper">
        <!-- Sidebar: Deal Info -->
        <aside class="sidebar-panel">
          <div class="sidebar-header">
            <h3 class="sidebar-title">Deal ì •ë³´</h3>
            <p class="sidebar-subtitle">í˜„ì¬ ì‘ì—… ì¤‘ì¸ Deal</p>
          </div>
          <div id="deal-info"></div>
          <div class="progress-indicator">
            <div class="progress-label">Discovery ì§„í–‰ë¥ </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
          </div>
        </aside>

        <!-- Main: Discovery Phases -->
        <section class="main-panel">
          <div class="main-header">
            <h1 class="main-title">Discovery ì…ë ¥</h1>
            <p class="main-subtitle">
              ê³ ê°ì˜ êµ¬ë§¤ ì—¬ì •(Buyer Journey)ì„ ë‹¨ê³„ë³„ë¡œ íŒŒì•…í•˜ì—¬ íš¨ê³¼ì ì¸ ì˜ì—… ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.
              ê° ë‹¨ê³„ì—ì„œ ê³ ê°ì˜ í–‰ë™, ê°ì •, ì ‘ì , ë¬¸ì œë¥¼ ì…ë ¥í•˜ë©´ AIê°€ JTBDì™€ To-Doë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            </p>
          </div>
          <div class="phase-sections" id="phases"></div>
        </section>
      </div>
    </main>

    <div class="save-banner" id="save-banner">
      âœ“ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤
    </div>
  </div>

  <script>
    const STORAGE_KEY = "bada_deals";
    const phaseNames = ["ì¸ì‹", "ê³ ë ¤", "í‰ê°€", "êµ¬ë§¤"];
    const questions = ["ê³ ê° í–‰ë™", "ê³ ê° ê°ì •", "ê³ ê° ì ‘ì ", "ê³ ê° ë¬¸ì œ"];

    let dealData = null;
    let dealId = null;

    // ì´ˆê¸°í™”
    document.addEventListener("DOMContentLoaded", () => {
      dealId = new URLSearchParams(window.location.search).get("dealId");
      
      if (!dealId) {
        alert("Deal IDê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        window.location.href = "index.html";
        return;
      }

      loadDealData();
      renderDealInfo();
      renderPhases();
      updateProgress();
    });

    // Deal ë°ì´í„° ë¡œë“œ
    function loadDealData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const deals = raw ? JSON.parse(raw) : {};
      dealData = deals[dealId];

      if (!dealData) {
        alert("Deal ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        window.location.href = "index.html";
        return;
      }

      if (!dealData.discovery) {
        dealData.discovery = {};
      }
    }

    // Deal ì •ë³´ í‘œì‹œ
    function renderDealInfo() {
      const dealInfoEl = document.getElementById("deal-info");
      const m = dealData.meta;

      const items = [
        { label: "Deal ì´ë¦„", value: m.dealName },
        { label: "ê³ ê°ì‚¬", value: m.customerName },
        { label: "ê³ ê° ë‹´ë‹¹ì", value: m.buyerPersona },
        { label: "ì†”ë£¨ì…˜", value: m.solutionName },
        { label: "ë‹¨ê³„", value: m.stage },
        { label: "ìì‚¬ ë‹´ë‹¹ì", value: m.ownerName },
      ];

      dealInfoEl.innerHTML = items
        .map(
          (item) => `
        <div class="deal-info-item">
          <div class="deal-info-label">${item.label}</div>
          <div class="deal-info-value">${item.value || "(ì…ë ¥ ì—†ìŒ)"}</div>
        </div>
      `
        )
        .join("");
    }

    // Phase ì„¹ì…˜ ë Œë”ë§
    function renderPhases() {
      const phasesEl = document.getElementById("phases");

      phaseNames.forEach((phaseName, phaseIdx) => {
        const section = document.createElement("div");
        section.className = "phase-section";
        if (phaseIdx === 0) section.classList.add("open");

        const header = document.createElement("div");
        header.className = "phase-header";
        header.innerHTML = `
          <div class="phase-header-left">
            <div class="phase-number">${phaseIdx + 1}</div>
            <div class="phase-title">${phaseName} ë‹¨ê³„</div>
          </div>
          <div class="phase-toggle">â–¼</div>
        `;

        header.onclick = () => {
          section.classList.toggle("open");
        };

        const content = document.createElement("div");
        content.className = "phase-content";

        const inputs = {};

        questions.forEach((q) => {
          const field = document.createElement("div");
          field.className = "question-field";

          const label = document.createElement("label");
          label.className = "question-label";
          label.textContent = q;

          const textarea = document.createElement("textarea");
          textarea.placeholder = `${phaseName} ë‹¨ê³„ì—ì„œì˜ ${q}ì„ ì…ë ¥í•˜ì„¸ìš”...`;
          
          // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
          const savedKey = `${phaseName}_${q}`;
          if (dealData.discovery[savedKey]) {
            textarea.value = dealData.discovery[savedKey];
          }

          // ìë™ ì €ì¥
          textarea.addEventListener("blur", () => {
            saveDealData(savedKey, textarea.value);
          });

          inputs[q] = textarea;

          field.appendChild(label);
          field.appendChild(textarea);
          content.appendChild(field);
        });

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "phase-actions";

        const btnGenerate = document.createElement("button");
        btnGenerate.className = "btn-primary";
        btnGenerate.innerHTML = `<span>âœ¨</span><span>Insight ìƒì„±</span>`;
        btnGenerate.onclick = () => generateInsight(phaseName, inputs, content);

        const btnSave = document.createElement("button");
        btnSave.className = "btn-secondary";
        btnSave.innerHTML = `<span>ğŸ’¾</span><span>ì €ì¥</span>`;
        btnSave.onclick = () => {
          questions.forEach((q) => {
            const savedKey = `${phaseName}_${q}`;
            saveDealData(savedKey, inputs[q].value);
          });
          showSaveBanner();
        };

        actionsDiv.appendChild(btnGenerate);
        actionsDiv.appendChild(btnSave);
        content.appendChild(actionsDiv);

        const outputDiv = document.createElement("div");
        outputDiv.className = "output-boxes";
        outputDiv.id = `output-${phaseIdx}`;

        // ê¸°ì¡´ insight ë¡œë“œ
        const jtbdKey = `${phaseName}_jtbd`;
        const todoKey = `${phaseName}_todo`;
        if (dealData.discovery[jtbdKey] || dealData.discovery[todoKey]) {
          outputDiv.innerHTML = `
            <div class="output-box">
              <strong>ê³ ê° JTBD (Jobs To Be Done)</strong>
              ${dealData.discovery[jtbdKey] || "(ìƒì„±ë˜ì§€ ì•ŠìŒ)"}
            </div>
            <div class="output-box">
              <strong>íŒë§¤ì To-Do</strong>
              ${dealData.discovery[todoKey] || "(ìƒì„±ë˜ì§€ ì•ŠìŒ)"}
            </div>
          `;
        }

        content.appendChild(outputDiv);

        section.appendChild(header);
        section.appendChild(content);
        phasesEl.appendChild(section);
      });
    }

    // Insight ìƒì„±
    async function generateInsight(phaseName, inputs, contentEl) {
      const outputDiv = contentEl.querySelector(".output-boxes");
      outputDiv.innerHTML = `
        <div class="output-box output-loading">
          <strong>â³ AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</strong>
          ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
        </div>
      `;

      const inputText = questions
        .map((q) => `${q}: ${inputs[q].value || "(ì…ë ¥ ì—†ìŒ)"}`)
        .join("\n");

      const prompt = `ë‹¤ìŒì€ B2B ì˜ì—…ì—ì„œ "${phaseName}" ë‹¨ê³„ì˜ ê³ ê° ì •ë³´ì…ë‹ˆë‹¤.

${inputText}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ì‘ì„±í•´ì£¼ì„¸ìš”:

1. ê³ ê°ì´ í•˜ë ¤ëŠ” ì¼ (JTBD - Jobs To Be Done):
ê³ ê°ì´ ì´ ë‹¨ê³„ì—ì„œ ë‹¬ì„±í•˜ë ¤ëŠ” ëª©í‘œì™€ í•´ê²°í•˜ë ¤ëŠ” ë¬¸ì œë¥¼ 3-5ì¤„ë¡œ ì‘ì„±

2. íŒë§¤ìì˜ To-Do:
ì˜ì—… ë‹´ë‹¹ìê°€ ì´ ë‹¨ê³„ì—ì„œ ìˆ˜í–‰í•´ì•¼ í•  êµ¬ì²´ì ì¸ ì•¡ì…˜ ì•„ì´í…œì„ 3-5ì¤„ë¡œ ì‘ì„±

ì‘ë‹µ í˜•ì‹:
[JTBD ì‹œì‘]
(ì—¬ê¸°ì— JTBD ë‚´ìš©)
[JTBD ë]

[To-Do ì‹œì‘]
(ì—¬ê¸°ì— To-Do ë‚´ìš©)
[To-Do ë]`;

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbwfmecME5u6IeXYV6UmYyMuNZGa3DFbqZ1zg2d7WuiEY1MFqTvrU4BpMXMftGDZh16PUw/exec", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            prompt: prompt
          }),
        });

        const data = await response.json();
        const geminiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "";

        let jtbd = "(JTBDë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤)";
        let todo = "(To-Doë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤)";

        // ì‘ë‹µ íŒŒì‹±
        const jtbdMatch = geminiResponse.match(/\[JTBD ì‹œì‘\]([\s\S]*?)\[JTBD ë\]/);
        const todoMatch = geminiResponse.match(/\[To-Do ì‹œì‘\]([\s\S]*?)\[To-Do ë\]/);

        if (jtbdMatch && jtbdMatch[1]) {
          jtbd = jtbdMatch[1].trim();
        } else {
          // ëŒ€ì²´ íŒŒì‹± ë°©ë²•
          const lines = geminiResponse.split("\n");
          let currentSection = "";
          let jtbdLines = [];
          let todoLines = [];

          lines.forEach((line) => {
            const lowerLine = line.toLowerCase();
            if (lowerLine.includes("jtbd") || lowerLine.includes("jobs to be done") || lowerLine.includes("í•˜ë ¤ëŠ” ì¼")) {
              currentSection = "jtbd";
            } else if (lowerLine.includes("to-do") || lowerLine.includes("todo") || lowerLine.includes("íŒë§¤ì")) {
              currentSection = "todo";
            } else if (line.trim() && !line.includes("**") && !line.includes("##")) {
              if (currentSection === "jtbd") {
                jtbdLines.push(line.trim());
              } else if (currentSection === "todo") {
                todoLines.push(line.trim());
              }
            }
          });

          if (jtbdLines.length > 0) jtbd = jtbdLines.join("\n");
          if (todoLines.length > 0) todo = todoLines.join("\n");
        }

        if (todoMatch && todoMatch[1]) {
          todo = todoMatch[1].trim();
        }

        // ì €ì¥
        saveDealData(`${phaseName}_jtbd`, jtbd);
        saveDealData(`${phaseName}_todo`, todo);

        outputDiv.innerHTML = `
          <div class="output-box">
            <strong>ê³ ê°ì´ í•˜ë ¤ëŠ” ì¼ (JTBD)</strong>
            ${jtbd}
          </div>
          <div class="output-box">
            <strong>íŒë§¤ìì˜ To-Do</strong>
            ${todo}
          </div>
        `;

        updateProgress();
        showSaveBanner();
        
      } catch (error) {
        console.error("Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
        outputDiv.innerHTML = `
          <div class="output-box output-error">
            <strong>âš ï¸ ì˜¤ë¥˜ ë°œìƒ</strong>
            AI ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
            <br><small>ì˜¤ë¥˜ ë‚´ìš©: ${error.message}</small>
          </div>
        `;
      }
    }

    // ë°ì´í„° ì €ì¥
    function saveDealData(key, value) {
      const raw = localStorage.getItem(STORAGE_KEY);
      const deals = raw ? JSON.parse(raw) : {};

      if (!deals[dealId]) return;

      deals[dealId].discovery[key] = value;
      deals[dealId].meta.updatedAt = new Date().toISOString();

      localStorage.setItem(STORAGE_KEY, JSON.stringify(deals));
      dealData = deals[dealId];
      updateProgress();
    }

    // ì €ì¥ ë°°ë„ˆ í‘œì‹œ
    function showSaveBanner() {
      const banner = document.getElementById("save-banner");
      banner.classList.add("show");
      setTimeout(() => {
        banner.classList.remove("show");
      }, 2000);
    }

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    function updateProgress() {
      const totalFields = phaseNames.length * (questions.length + 2); // ì§ˆë¬¸ + JTBD + Todo
      let filledFields = 0;

      phaseNames.forEach((phase) => {
        questions.forEach((q) => {
          const key = `${phase}_${q}`;
          if (dealData.discovery[key] && dealData.discovery[key].trim()) {
            filledFields++;
          }
        });

        // JTBDì™€ Todo ì²´í¬
        const jtbdKey = `${phase}_jtbd`;
        const todoKey = `${phase}_todo`;
        if (dealData.discovery[jtbdKey] && dealData.discovery[jtbdKey].trim()) {
          filledFields++;
        }
        if (dealData.discovery[todoKey] && dealData.discovery[todoKey].trim()) {
          filledFields++;
        }
      });

      const percentage = Math.round((filledFields / totalFields) * 100);
      document.getElementById("progress-fill").style.width = `${percentage}%`;
    }
  </script>
</body>
</html}
