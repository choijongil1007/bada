<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Discovery - BADA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #f9fafb;
        display: flex;
        height: 100vh;
      }
      .container {
        display: flex;
        flex-direction: row;
        width: 100%;
      }
      .sidebar {
        width: 25%;
        background-color: #ffffff;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
      }
      .main {
        width: 75%;
        padding: 20px;
        overflow-y: auto;
      }
      .section {
        margin-bottom: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background-color: #ffffff;
      }
      .section-header {
        background-color: #f3f4f6;
        padding: 10px;
        cursor: pointer;
        border-radius: 10px 10px 0 0;
        font-weight: bold;
      }
      .section-content {
        display: none;
        padding: 15px;
      }
      textarea {
        width: 100%;
        height: 50px;
        margin-bottom: 10px;
        resize: vertical;
      }
      .output-box {
        margin-top: 10px;
        padding: 10px;
        background-color: #ecfdf5;
        border-left: 4px solid #10b981;
      }
      button {
        background-color: #10b981;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h3>Deal 정보</h3>
        <div id="deal-info"></div>
      </div>
      <div class="main">
        <h2>Discovery 입력</h2>
        <div id="phases"></div>
      </div>
    </div>

    <script>
      const dealID = new URLSearchParams(window.location.search).get('deal');
      const dealData = JSON.parse(localStorage.getItem('deals') || '{}')[dealID];

      const phaseNames = ['인식', '고려', '평가', '구매'];
      const questions = ['고객 행동', '고객 감정', '고객 접점', '고객 문제'];

      document.getElementById('deal-info').innerHTML = dealData ? `
        <p><strong>Deal 이름:</strong> ${dealData.name}</p>
        <p><strong>고객사:</strong> ${dealData.customer}</p>
        <p><strong>고객 담당자:</strong> ${dealData.persona}</p>
        <p><strong>솔루션:</strong> ${dealData.solution}</p>
        <p><strong>단계:</strong> ${dealData.stage}</p>
        <p><strong>자사 담당자:</strong> ${dealData.owner}</p>
        <p><strong>메모:</strong> ${dealData.memo}</p>
      ` : '<p>Deal 정보를 불러올 수 없습니다.</p>';

      const phasesEl = document.getElementById('phases');
      phaseNames.forEach((phase, idx) => {
        const section = document.createElement('div');
        section.className = 'section';

        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerText = phase;
        header.onclick = () => {
          content.style.display = content.style.display === 'none' ? 'block' : 'none';
        };

        const content = document.createElement('div');
        content.className = 'section-content';
        if (idx === 0) content.style.display = 'block';

        const inputs = {};
        questions.forEach(q => {
          const label = document.createElement('label');
          label.innerText = q;
          const textarea = document.createElement('textarea');
          textarea.placeholder = `${phase} 단계의 ${q}`;
          inputs[q] = textarea;
          content.appendChild(label);
          content.appendChild(textarea);
        });

        const btn = document.createElement('button');
        btn.innerText = 'Insight 생성';
        btn.onclick = async () => {
          const inputText = questions.map(q => `${q}: ${inputs[q].value}`).join('\n');
          const prompt = `다음은 ${phase} 단계의 고객 정보입니다.\n${inputText}\n이 고객의 하려는 일(JTBD)과 To-Do를 작성해줘.`;

          const response = await callGemini(prompt);
          const jtbd = document.createElement('div');
          jtbd.className = 'output-box';
          jtbd.innerText = `고객 JTBD:\n${response.jtbd}`;
          const todo = document.createElement('div');
          todo.className = 'output-box';
          todo.innerText = `판매자 To-Do:\n${response.todo}`;
          content.appendChild(jtbd);
          content.appendChild(todo);
        };
        content.appendChild(btn);

        section.appendChild(header);
        section.appendChild(content);
        phasesEl.appendChild(section);
      });

      async function callGemini(prompt) {
        const apiKey = 'YOUR_GEMINI_API_KEY';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
        const body = {
          contents: [{ parts: [{ text: prompt }] }]
        };
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const result = await res.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
          const [jtbd, todo] = text.split('판매자 To-Do:');
          return {
            jtbd: jtbd.replace('고객 JTBD:', '').trim(),
            todo: todo?.trim() || '(To-Do 없음)'
          };
        } catch (e) {
          return { jtbd: '[오류 발생]', todo: '' };
        }
      }
    </script>
  </body>
</html>
