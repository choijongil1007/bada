<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>BADA â€“ Discovery (BSA Framework)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="header-inner">
        <div class="brand">
          <div class="brand-logo">B</div>
          <div>
            <div class="brand-text-main">BADA Discovery</div>
            <div class="brand-text-sub">BSA í”„ë ˆì„ì›Œí¬ ê¸°ë°˜ ê³ ê° ì—¬ì • ì…ë ¥</div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="content-inner">
        <section class="panel" style="width:100%">
          <div class="panel-header">
            <h2 class="panel-title">ê³ ê° ì—¬ì • ë‹¨ê³„ë³„ ì…ë ¥</h2>
            <p class="panel-subtitle">Insight ê¸°ë°˜ Discovery ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ìƒì„±í•´ë³´ì„¸ìš”.</p>
          </div>
          <div id="dealNamePill" class="badge">Loading Deal...</div>
          <div id="stages"></div>
        </section>
      </div>
    </main>

    <footer>
      <div style="text-align:center; font-size:12px; padding:20px; color:var(--text-muted);">
        &copy; 2025 BADA Framework Â· Powered by PreSales Lab
      </div>
    </footer>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const dealId = urlParams.get("dealId");
    let dealData = {};

    function goBack() {
      window.location.href = "index.html";
    }

    function loadDeal() {
      const stored = localStorage.getItem("bada_deals");
      if (!stored) return;

      let dealList = {};
      try {
        dealList = JSON.parse(stored);
      } catch (e) {
        console.error("JSON íŒŒì‹± ì˜¤ë¥˜", e);
        return;
      }

      const found = dealList[dealId];
      if (!found) return;

      dealData = found;
      document.getElementById("dealNamePill").innerText = found.meta?.dealName || "Deal ì •ë³´ ì—†ìŒ";
    }

    const journeyStages = [
      "Awareness", "Consideration", "Evaluation", "Purchase",
      "Onboarding", "Adoption & Retention", "Expansion", "Renewal"
    ];

    function renderStages() {
      const container = document.getElementById("stages");
      journeyStages.forEach((stage) => {
        const box = document.createElement("div");
        box.className = "stage-box";
        box.innerHTML = `
          <div class="stage-name">${stage}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <textarea placeholder="ê³ ê° í–‰ë™" id="${stage}-behavior"></textarea>
            <textarea placeholder="ê³ ê° ê°ì •" id="${stage}-emotion"></textarea>
            <textarea placeholder="ì •ë³´ ì±„ë„" id="${stage}-channel"></textarea>
            <textarea placeholder="ë¬¸ì œì " id="${stage}-pain"></textarea>
          </div>
          <div class="ai-buttons">
            <button class="btn-primary" onclick="generateJTBDAndToDo('${stage}')">ğŸ’¡ Insight ìƒì„±</button>
          </div>
          <textarea placeholder="JTBD" id="${stage}-jtbd"></textarea>
          <textarea placeholder="Seller To-Do" id="${stage}-todo"></textarea>
        `;
        container.appendChild(box);
      });
    }

    async function callGeminiViaGAS(prompt) {
      const gasUrl = 'https://script.google.com/macros/s/AKfycbz5eg5E4664lvp6OL2qS-vUx7CoxpyPpuov3eRMxArZCFmTrhkPMQQGql-TyEX1fZJBeg/exec';
      const response = await fetch(gasUrl, {
        method: 'POST',
        body: JSON.stringify({ prompt }),
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ê²°ê³¼ ì—†ìŒ";
      return text;
    }

    function buildPrompt(stage) {
      const behavior = document.getElementById(`${stage}-behavior`).value;
      const emotion = document.getElementById(`${stage}-emotion`).value;
      const channel = document.getElementById(`${stage}-channel`).value;
      const pain = document.getElementById(`${stage}-pain`).value;
      return `
ë‹¹ì‹ ì€ B2B ê³ ê° ì—¬ì • ì „ëµê°€ì…ë‹ˆë‹¤. ì•„ë˜ ê³ ê° ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê³ ê°ì˜ JTBDì™€ í”„ë¦¬ì„¸ì¼ì¦ˆ ë‹´ë‹¹ìì˜ To-Doë¥¼ ìƒì„±í•˜ì„¸ìš”.

[ê³ ê° ì—¬ì • ë‹¨ê³„] ${stage}
[ê³ ê° í–‰ë™] ${behavior}
[ê°ì •] ${emotion}
[ì •ë³´ ì±„ë„] ${channel}
[ë¬¸ì œì ] ${pain}

ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”:

ê³ ê°ì˜ JTBDëŠ” ~ì´ë‹¤.
Seller To-Do:
- ~
- ~
`;
    }

    async function generateJTBDAndToDo(stage) {
      const prompt = buildPrompt(stage);
      const result = await callGeminiViaGAS(prompt);
      const [jtbdLine, ...todoLines] = result.split("\n").filter(line => line.trim() !== "");
      document.getElementById(`${stage}-jtbd`).value = jtbdLine || "";
      document.getElementById(`${stage}-todo`).value = todoLines.join("\n");
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadDeal();
      renderStages();
    });
  </script>
</body>
</html>
