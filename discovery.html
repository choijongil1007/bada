<!-- ì¤‘ê°„ ìƒëµ ì—†ì´ ì „ì²´ ìˆ˜ì • ë°˜ì˜ë³¸ì…ë‹ˆë‹¤ -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>BADA â€“ Discovery (BSA Framework)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* [ìŠ¤íƒ€ì¼ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë¨ - ìƒëµ ê°€ëŠ¥] */
    /* ... ìŠ¤íƒ€ì¼ ì „ì²´ëŠ” ìƒëµ ê°€ëŠ¥ (ì§ˆë¬¸ì—ì„œì™€ ë™ì¼í•˜ë¯€ë¡œ) ... */
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-inner">
        <div class="logo-area">
          <div class="logo-badge">B</div>
          <div class="logo-text">
            <div class="logo-text-main">BADA Discovery</div>
            <div class="logo-text-sub">BSA í”„ë ˆì„ì›Œí¬ ì…ë ¥</div>
          </div>
        </div>
        <div class="header-right">
          <div id="dealNamePill" class="pill">Loading Deal...</div>
          <button class="btn secondary" onclick="goBack()">â† ëª©ë¡ìœ¼ë¡œ</button>
        </div>
      </div>
    </header>
    <main>
      <div class="main-inner">
        <div>
          <div class="section-title">ê³ ê° ì—¬ì • ë‹¨ê³„ë³„ ì…ë ¥</div>
          <div id="stages"></div>
        </div>
      </div>
    </main>
    <footer>
      &copy; 2025 BADA Framework Â· Powered by PreSales Lab
    </footer>
  </div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const dealId = urlParams.get("dealId");
    let dealData = {};
    let dealList = []; // ì „ì—­ ë³€ìˆ˜

    function goBack() {
      window.location.href = "index.html";
    }

    function loadDeal() {
      const stored = localStorage.getItem("bada_deals");
      if (!stored) {
        console.warn("â—ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— 'bada_deals' ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      try {
        dealList = JSON.parse(stored); // ì´ì¤‘ ì„ ì–¸ ì œê±°
        if (!Array.isArray(dealList)) {
          console.error("â— 'bada_deals' ê°’ì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", dealList);
          return;
        }
      } catch (err) {
        console.error("â— JSON íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        return;
      }

      const found = dealList.find((d) => d.id === dealId);
      if (!found) {
        console.warn("â— í•´ë‹¹ dealIdë¥¼ ê°€ì§„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", dealId);
        return;
      }

      dealData = found;
      document.getElementById("dealNamePill").innerText = found.name;
    }

    const journeyStages = [
      "Awareness", "Consideration", "Evaluation", "Purchase",
      "Onboarding", "Adoption & Retention", "Expansion", "Renewal"
    ];

    function renderStages() {
      const container = document.getElementById("stages");
      journeyStages.forEach((stage) => {
        const box = document.createElement("div");
        box.className = "stage-box";
        box.innerHTML = `
          <div class="stage-name">${stage}</div>
          <textarea placeholder="ê³ ê° í–‰ë™" id="${stage}-behavior"></textarea>
          <textarea placeholder="ê³ ê° ê°ì •" id="${stage}-emotion"></textarea>
          <textarea placeholder="ì •ë³´ ì±„ë„" id="${stage}-channel"></textarea>
          <textarea placeholder="ë¬¸ì œì " id="${stage}-pain"></textarea>
          <div class="ai-buttons">
            <button class="btn ai" onclick="generateJTBDAndToDo('${stage}')">ğŸ’¡ Insight ìƒì„±</button>
          </div>
          <textarea placeholder="JTBD" id="${stage}-jtbd"></textarea>
          <textarea placeholder="Seller To-Do" id="${stage}-todo"></textarea>
        `;
        container.appendChild(box);
      });
    }

    async function callGeminiViaGAS(prompt) {
      const gasUrl = 'https://script.google.com/macros/s/AKfycbz5eg5E4664lvp6OL2qS-vUx7CoxpyPpuov3eRMxArZCFmTrhkPMQQGql-TyEX1fZJBeg/exec'; // ì‹¤ì œ ë°°í¬ URL ì‚¬ìš©

      const response = await fetch(gasUrl, {
        method: 'POST',
        body: JSON.stringify({ prompt }),
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ê²°ê³¼ ì—†ìŒ";
      return text;
    }

    function buildPrompt(stage) {
      const behavior = document.getElementById(`${stage}-behavior`).value;
      const emotion = document.getElementById(`${stage}-emotion`).value;
      const channel = document.getElementById(`${stage}-channel`).value;
      const pain = document.getElementById(`${stage}-pain`).value;
      return `
ë‹¹ì‹ ì€ B2B ê³ ê° ì—¬ì • ì „ëµê°€ì…ë‹ˆë‹¤. ì•„ë˜ ê³ ê° ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê³ ê°ì˜ JTBDì™€ í”„ë¦¬ì„¸ì¼ì¦ˆ ë‹´ë‹¹ìì˜ To-Doë¥¼ ìƒì„±í•˜ì„¸ìš”.

[ê³ ê° ì—¬ì • ë‹¨ê³„] ${stage}
[ê³ ê° í–‰ë™] ${behavior}
[ê°ì •] ${emotion}
[ì •ë³´ ì±„ë„] ${channel}
[ë¬¸ì œì ] ${pain}

ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”:

ê³ ê°ì˜ JTBDëŠ” ~ì´ë‹¤.
Seller To-Do:
- ~
- ~
`;
    }

    async function generateJTBDAndToDo(stage) {
      const prompt = buildPrompt(stage);
      const result = await callGeminiViaGAS(prompt); // í•¨ìˆ˜ëª… ì •í™•íˆ ìˆ˜ì •
      const [jtbdLine, ...todoLines] = result.split("\n").filter(line => line.trim() !== "");
      document.getElementById(`${stage}-jtbd`).value = jtbdLine || "";
      document.getElementById(`${stage}-todo`).value = todoLines.join("\n");
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadDeal();
      renderStages();
    });
  </script>
</body>
</html>
